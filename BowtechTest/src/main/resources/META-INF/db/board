--■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■BOARD TABLE■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
--테이블 생성
DROP TABLE BOARD;
CREATE TABLE BOARD (
    BNUM NUMBER(5) PRIMARY KEY,
    BPW VARCHAR2(20) NOT NULL,
    BNAME VARCHAR2(20) NOT NULL,
    BTITLE VARCHAR2(50) NOT NULL,
    BCONTENT VARCHAR2(1000) NOT NULL,
    BGROUP NUMBER(5) NOT NULL,
    BSTEP NUMBER(5) NOT NULL,
    BINDENT NUMBER(5) NOT NULL,
    BHIT NUMBER(5) NOT NULL,
    BSTATUS NUMBER(1) NOT NULL,
    BPARENTNUM NUMBER(5) NOT NULL,
    BRDATE DATE DEFAULT SYSDATE);

--시퀀스 생성
DROP SEQUENCE SEQ_BOARD;
CREATE SEQUENCE SEQ_BOARD
  START WITH 1
  INCREMENT BY 1
  NOMAXVALUE 
  NOCACHE;
 
 
COMMIT;
--액셀 다운 용 리스트.
SELECT BNUM, BNAME, BTITLE, BRDATE, BHIT FROM BOARD;
--게시글 상세보기.
SELECT * FROM BOARD WHERE BNUM=1;

select * from board;
--게시글 리스트.
SELECT * FROM 
    (SELECT ROWNUM RN, D.* FROM
        (SELECT A.*,NVL(B.BSTATUS,0) PARENTSTATUS, NVL(C.FILECNT,0) FILECNT, NVL(D.COMENTCNT,0)COMMENTCNT FROM
             BOARD A, 
             BOARD B, 
            (SELECT F.BNUM, COUNT(*) FILECNT FROM BOARD_FILE F, BOARD B WHERE F.BNUM=B.BNUM AND F.FSTATUS=0 GROUP BY F.BNUM)C,
            (SELECT BNUM, COUNT(*) COMENTCNT FROM BOARD_COMENT GROUP BY BNUM)D
        WHERE A.BPARENTNUM=B.BNUM(+) AND A.BNUM=C.BNUM(+) AND A.BSTATUS=0 AND A.BNUM=D.BNUM(+) ORDER BY A.BGROUP DESC, A.BSTEP)D)
    WHERE RN BETWEEN 1 AND 10;



SELECT count(*) FROM 
    (SELECT ROWNUM RN, D.* FROM
        (SELECT A.*,NVL(B.BSTATUS,0) PARENTSTATUS, NVL(C.FILECNT,0) FILECNT, NVL(D.COMENTCNT,0)COMMENTCNT FROM
             BOARD A, 
             BOARD B, 
            (SELECT F.BNUM, COUNT(*) FILECNT FROM BOARD_FILE F, BOARD B WHERE F.BNUM=B.BNUM AND F.FSTATUS=0 GROUP BY F.BNUM)C,
            (SELECT BNUM, COUNT(*) COMENTCNT FROM BOARD_COMENT GROUP BY BNUM)D
        WHERE A.BPARENTNUM=B.BNUM(+) AND A.BNUM=C.BNUM(+) AND A.BSTATUS=0 AND A.BNUM=D.BNUM(+) ORDER BY A.BGROUP DESC, A.BSTEP)D)
    WHERE RN BETWEEN 1 AND 10 AND BPARENTNUM=0;


--게시글 등록(원글).원글의 부모값은 0 으로 하자.
INSERT INTO BOARD(BNUM, BPW, BNAME, BTITLE, BCONTENT, BGROUP, BSTEP, BINDENT, BHIT, BSTATUS, BPARENTNUM, BRDATE) 
    VALUES(SEQ_BOARD.NEXTVAL, 'PASSWORD', 'BNAME', 'BTITLE1111111111111111111111111', 'BCONTENT', SEQ_BOARD.CURRVAL, 0, 0, 0, 0, 0, SYSDATE);

--게시글 등록(답변).
UPDATE BOARD SET BSTEP=BSTEP+1 WHERE BSTEP>0; --원글보다 스텝이 큰 애들 모두 +1씩 증가
INSERT INTO BOARD(BNUM, BPW, BNAME, BTITLE, BCONTENT, BGROUP, BSTEP, BINDENT, BHIT, BSTATUS, BPARENTNUM, BRDATE) 
    VALUES(SEQ_BOARD.NEXTVAL, 'PASSWORD', 'BNAME', 'BTITLE', 'BCONTENT', 1, 1, 1, 0, 0, 1, SYSDATE);

--게시글 삭제.(상태값만 바꿈)
UPDATE BOARD SET BSTATUS=0 WHERE BNUM=0;

--게시글 수정하기.
UPDATE BOARD SET BNAME='', BTITLE='', BCONTENT='' WHERE BNUM=0;

--게시글 조회수 올리기.
UPDATE BOARD SET BHIT=BHIT+1 WHERE BNUM=0;

--원 글의 총 갯수.
SELECT COUNT(*) FROM BOARD WHERE BPARENTNUM=0 AND BSTATUS=0;

--게시글 총 갯수.
SELECT COUNT(*) FROM BOARD;
COMMIT;


--게시글 작성자 이름으로 검색.
SELECT * FROM 
    (SELECT ROWNUM RN, D.* FROM
        (SELECT A.*,NVL(B.BSTATUS,0) PARENTSTATUS, NVL(C.FILECNT,0) FILECNT, NVL(D.COMENTCNT,0)COMMENTCNT FROM
             BOARD A, 
             BOARD B, 
            (SELECT F.BNUM, COUNT(*) FILECNT FROM BOARD_FILE F, BOARD B WHERE F.BNUM=B.BNUM AND F.FSTATUS=0 GROUP BY F.BNUM)C,
            (SELECT BNUM, COUNT(*) COMENTCNT FROM BOARD_COMENT GROUP BY BNUM)D
        WHERE A.BPARENTNUM=B.BNUM(+) AND A.BNUM=C.BNUM(+) AND A.BSTATUS=0 AND A.BNUM=D.BNUM(+) ORDER BY A.BGROUP DESC, A.BSTEP)D)
    WHERE RN BETWEEN 1 AND 10 AND BNAME LIKE '%a%';

SELECT COUNT(*) FROM BOARD WHERE BNAME LIKE '%a%' AND BSTATUS=0;--작성자 이름으로 검색한 글 총 갯수.
SELECT COUNT(*) FROM BOARD WHERE BNAME LIKE '%a%' AND BSTATUS=0 AND BPARENTNUM=0; --작성자 이름으로 검색한 원글의 총 갯수.

--제목과 작성자로 검색.
SELECT * FROM 
    (SELECT ROWNUM RN, D.* FROM
        (SELECT A.*,NVL(B.BSTATUS,0) PARENTSTATUS, NVL(C.FILECNT,0) FILECNT, NVL(D.COMENTCNT,0)COMMENTCNT FROM
             BOARD A, 
             BOARD B, 
            (SELECT F.BNUM, COUNT(*) FILECNT FROM BOARD_FILE F, BOARD B WHERE F.BNUM=B.BNUM AND F.FSTATUS=0 GROUP BY F.BNUM)C,
            (SELECT BNUM, COUNT(*) COMENTCNT FROM BOARD_COMENT GROUP BY BNUM)D
        WHERE A.BPARENTNUM=B.BNUM(+) AND A.BNUM=C.BNUM(+) AND A.BSTATUS=0 AND A.BNUM=D.BNUM(+) ORDER BY A.BGROUP DESC, A.BSTEP)D)
    WHERE RN BETWEEN 1 AND 10 AND BNAME LIKE '%a%' AND BTITLE LIKE '%%';
SELECT COUNT(*) FROM BOARD WHERE BTITLE LIKE '%'||'특수'||'%' AND BSTATUS=0;
--■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■FILE TABLE■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
DROP TABLE BOARD_FILE;
CREATE TABLE BOARD_FILE(
    FNUM NUMBER(5) PRIMARY KEY,
    BNUM NUMBER(5) NOT NULL,
    FORIGIN_NAME VARCHAR2(300) NOT NULL,
    FSTORE_NAME VARCHAR2(300) NOT NULL,
    FSIZE NUMBER(10) NOT NULL,
    FSTATUS NUMBER(1) NOT NULL,
    FRDATE DATE DEFAULT SYSDATE);
    
DROP SEQUENCE SEQ_FILE;
CREATE SEQUENCE SEQ_FILE
    START WITH 1
    INCREMENT BY 1
    NOMAXVALUE
    NOCACHE;
    
--파일 등록
INSERT INTO BOARD_FILE(FNUM, BNUM, FORIGIN_NAME, FSTORE_NAME, FSIZE, FSTATUS, FRDATE)
    VALUES(SEQ_FILE.NEXTVAL, 1, '1.png', 'change1.png', 1000, 0, SYSDATE);
    
--파일 삭제 처리등록.
UPDATE BOARD_FILE SET FSTATUS=1 WHERE FNUM=1;

SELECT * FROM BOARD;
SELECT MAX(BNUM) FROM BOARD;

SELECT *
    FROM USER_SEQUENCES 
        WHERE SEQUENCE_NAME = UPPER('SEQ_BOARD');


--파일 삭제 처리등록 취소하기.
UPDATE BOARD_FILE SET FSTATUS=0 WHERE FNUM=1;

--파일 목록 갖고오기.
SELECT * FROM BOARD_FILE WHERE BNUM=1 AND FSTATUS=0;
SELECT * FROM BOARD_FILE ORDER BY FRDATE DESC;
SELECT * FROM BOARD_FILE;
SELECT * FROM BOARD_FILE WHERE FNUM=1;


--■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■BOARD_COMENT■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
DROP TABLE BOARD_COMENT;
CREATE TABLE BOARD_COMENT(
    CNUM NUMBER(5) PRIMARY KEY,
    CNAME VARCHAR2(30) NOT NULL,
    CCONTENT VARCHAR2(1000) NOT NULL,
    CPW VARCHAR2(50) NOT NULL,
    BNUM NUMBER(5) NOT NULL);

DROP SEQUENCE SEQ_COM;
CREATE SEQUENCE SEQ_COM
    START WITH 1
    INCREMENT BY 1
    NOMAXVALUE
    NOCACHE;
commit;
--댓글 쓰기.
INSERT INTO BOARD_COMENT(CNUM,CNAME,CCONTENT,CPW,BNUM)VALUES(SEQ_COM.NEXTVAL,'CNAME','CCONTENT','CPW',3);
--댓글 삭제하기.
DELETE FROM BOARD_COMENT WHERE CNUM=0;
--댓글 리스트 갖고오기.
SELECT * FROM BOARD_COMENT WHERE BNUM=9 ORDER BY CNUM DESC;
--해당 글의 댓글 총 갯수 갖고오기.
SELECT COUNT(*) FROM BOARD_COMENT WHERE BNUM=0;
--댓글 한 개의 정보 갖고오기.
SELECT * FROM BOARD_COMENT WHERE CNUM=1;
--댓글 수정하기.
UPDATE BOARD_COMENT SET CNAME='NUW_CNAME', CCONTENT='NEW_CCONTENT' WHERE CNUM=0;

SELECT * FROM BOARD_COMENT;